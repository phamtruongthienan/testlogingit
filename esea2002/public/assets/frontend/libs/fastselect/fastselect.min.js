!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):t(jQuery)}(function(t){var e=t(window.document),s=0,i=/\w\b/g,n={13:"enter",27:"escape",40:"downArrow",38:"upArrow"};function o(t,e){this.init.apply(this,arguments)}return t.extend(o.prototype,{init:function(e,i){i=this.options=t.extend(!0,{},o.defaults,i),this.$input=t(e),this.$el=i.wrapSelector instanceof t?i.wrapSelector:this.$input.closest(i.wrapSelector),o.pickTo(i,this.$el.data(),["url","onItemSelect","noResultsText","inputIdName","apiInputName"]),i.url=i.url||this.$el.attr("action"),this.ens=".fastsearch"+ ++s,this.itemSelector=o.selectorFromClass(i.itemClass),this.focusedItemSelector=o.selectorFromClass(i.focusedItemClass),this.events()},namespaceEvents:function(t){var e=this.ens;return t.replace(i,function(t){return t+e})},events:function(){var e=this,s=this.options;this.$input.on(this.namespaceEvents("keyup focus click"),function(t){"enter"!==n[t.keyCode]&&e.handleTyping()}).on(this.namespaceEvents("keydown"),function(t){if("enter"===n[t.keyCode]&&s.preventSubmit&&t.preventDefault(),e.hasResults&&e.resultsOpened)switch(n[t.keyCode]){case"downArrow":t.preventDefault(),e.navigateItem("down");break;case"upArrow":t.preventDefault(),e.navigateItem("up");break;case"enter":e.onEnter(t)}}),this.$el.on(this.namespaceEvents("click"),this.itemSelector,function(s){s.preventDefault(),e.handleItemSelect(t(this))}),s.mouseEvents&&this.$el.on(this.namespaceEvents("mouseleave"),this.itemSelector,function(e){t(this).removeClass(s.focusedItemClass)}).on(this.namespaceEvents("mouseenter"),this.itemSelector,function(i){e.$resultItems.removeClass(s.focusedItemClass),t(this).addClass(s.focusedItemClass)})},handleTyping:function(){var e=t.trim(this.$input.val()),s=this;e.length<this.options.minQueryLength?this.hideResults():e===this.query?this.showResults():(clearTimeout(this.keyupTimeout),this.keyupTimeout=setTimeout(function(){s.$el.addClass(s.options.loadingClass),s.query=e,s.getResults(function(t){s.showResults(s.storeResponse(t).generateResults(t))})},this.options.typeTimeout))},getResults:function(e){var s=this,i=this.options,n=this.$el.find("input, textarea, select").serializeArray();i.apiInputName&&n.push({name:i.apiInputName,value:this.$input.val()}),t.get(i.url,n,function(t){e(i.parseResponse?i.parseResponse.call(s,t,s):t)})},storeResponse:function(t){return this.responseData=t,this.hasResults=0!==t.length,this},generateResults:function(e){var s=t("<div>"),i=this.options;return i.template?t(i.template(e,this)):(0===e.length?s.html('<p class="'+i.noResultsClass+'">'+("function"==typeof i.noResultsText?i.noResultsText.call(this):i.noResultsText)+"</p>"):"html"===this.options.responseType?s.html(e):this["generate"+(e[0][i.responseFormat.groupItems]?"GroupedResults":"SimpleResults")](e,s),s.children())},generateSimpleResults:function(e,s){var i=this;this.itemModels=e,t.each(e,function(t,e){s.append(i.generateItem(e))})},generateGroupedResults:function(e,s){var i=this,n=this.options,o=n.responseFormat;this.itemModels=[],t.each(e,function(e,l){var a=t('<div class="'+n.groupClass+'">').appendTo(s);l[o.groupCaption]&&a.append('<h3 class="'+n.groupTitleClass+'">'+l[o.groupCaption]+"</h3>"),t.each(l.items,function(t,e){i.itemModels.push(e),a.append(i.generateItem(e))}),n.onGroupCreate&&n.onGroupCreate.call(i,a,l,i)})},generateItem:function(e){var s=this.options,i=s.responseFormat,n=e[i.url],o=e[i.html]||e[i.label],l=t("<"+(n?"a":"span")+">").html(o).addClass(s.itemClass);return n&&l.attr("href",n),s.onItemCreate&&s.onItemCreate.call(this,l,e,this),l},showResults:function(e){!e&&this.resultsOpened||(this.$el.removeClass(this.options.loadingClass).addClass(this.options.resultsOpenedClass),this.options.flipOnBottom&&this.checkDropdownPosition(),this.$resultsCont=this.$resultsCont||t("<div>").addClass(this.options.resultsContClass).appendTo(this.$el),e&&(this.$resultsCont.html(e),this.$resultItems=this.$resultsCont.find(this.itemSelector),this.options.onResultsCreate&&this.options.onResultsCreate.call(this,this.$resultsCont,this.responseData,this)),this.resultsOpened||(this.documentCancelEvents("on"),this.$input.trigger("openingResults")),this.options.focusFirstItem&&this.$resultItems&&this.$resultItems.length&&this.navigateItem("down"),this.resultsOpened=!0)},checkDropdownPosition:function(){var t=this.options.flipOnBottom,s="boolean"==typeof t&&t?400:t,i=this.$input.offset().top+s>e.height();this.$el.toggleClass(this.options.resultsFlippedClass,i)},documentCancelEvents:function(s,i){var o=this;if("off"===s&&this.closeEventsSetuped)return e.off(this.ens),void(this.closeEventsSetuped=!1);"on"!==s||this.closeEventsSetuped||(e.on(this.namespaceEvents("click keyup"),function(e){("escape"===n[e.keyCode]||!t(e.target).is(o.$el)&&!t.contains(o.$el.get(0),e.target)&&t.contains(document.documentElement,e.target))&&(i?i.call(o):o.hideResults())}),this.closeEventsSetuped=!0)},navigateItem:function(t){var e=this.$resultItems.filter(this.focusedItemSelector),s=this.$resultItems.length-1;if(0!==e.length){var i=this.$resultItems.index(e),n="up"===t?i-1:i+1;n>s&&(n=0),n<0&&(n=s),e.removeClass(this.options.focusedItemClass),this.$resultItems.eq(n).addClass(this.options.focusedItemClass)}else this.$resultItems.eq("up"===t?s:0).addClass(this.options.focusedItemClass)},navigateDown:function(){this.navigateItem("down")},navigateUp:function(){this.navigateItem("up")},onEnter:function(t){var e=this.$resultItems.filter(this.focusedItemSelector);e.length&&(t.preventDefault(),this.handleItemSelect(e))},handleItemSelect:function(t){var e=this.options.onItemSelect,s=this.itemModels.length?this.itemModels[this.$resultItems.index(t)]:{};this.$input.trigger("itemSelected"),"fillInput"===e?this.fillInput(s):"follow"===e?window.location.href=t.attr("href"):"function"==typeof e&&e.call(this,t,s,this)},fillInput:function(e){var s=this.options,i=s.responseFormat;if(this.query=e[i.label],this.$input.val(e[i.label]).trigger("change"),s.fillInputId&&e.id){if(!this.$inputId){var n=s.inputIdName||this.$input.attr("name")+"_id";this.$inputId=this.$el.find('input[name="'+n+'"]'),this.$inputId.length||(this.$inputId=t('<input type="hidden" name="'+n+'" />').appendTo(this.$el))}this.$inputId.val(e.id).trigger("change")}this.hideResults()},hideResults:function(){return this.resultsOpened&&(this.resultsOpened=!1,this.$el.removeClass(this.options.resultsOpenedClass),this.$input.trigger("closingResults"),this.documentCancelEvents("off")),this},clear:function(){return this.hideResults(),this.$input.val("").trigger("change"),this},destroy:function(){e.off(this.ens),this.$input.off(this.ens),this.$el.off(this.ens).removeClass(this.options.resultsOpenedClass).removeClass(this.options.loadingClass),this.$resultsCont&&(this.$resultsCont.remove(),delete this.$resultsCont),delete this.$el.data().fastsearch}}),t.extend(o,{pickTo:function(e,s,i){return t.each(i,function(t,i){e[i]=s&&s[i]||e[i]}),e},selectorFromClass:function(t){return"."+t.replace(/\s/g,".")}}),o.defaults={wrapSelector:"form",url:null,responseType:"JSON",preventSubmit:!1,resultsContClass:"fs_results",resultsOpenedClass:"fsr_opened",resultsFlippedClass:"fsr_flipped",groupClass:"fs_group",itemClass:"fs_result_item",groupTitleClass:"fs_group_title",loadingClass:"loading",noResultsClass:"fs_no_results",focusedItemClass:"focused",typeTimeout:140,minQueryLength:2,template:null,mouseEvents:!("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0),focusFirstItem:!1,flipOnBottom:!1,responseFormat:{url:"url",html:"html",label:"label",groupCaption:"caption",groupItems:"items"},fillInputId:!0,inputIdName:null,apiInputName:null,noResultsText:"No results found",onItemSelect:"follow",parseResponse:null,onResultsCreate:null,onGroupCreate:null,onItemCreate:null},t.fastsearch=o,t.fn.fastsearch=function(e){return this.each(function(){t.data(this,"fastsearch")||t.data(this,"fastsearch",new o(this,e))})},t}),function(t,e){"function"==typeof define&&define.amd?define(["jquery","fastsearch"],e):"object"==typeof module&&module.exports?module.exports=e(require("jquery"),require("fastsearch")):e(t.jQuery)}(this,function(t){var e=t(document),s=0,i=t.fastsearch,n=i.pickTo,o=i.selectorFromClass;function l(t,e){this.init.apply(this,arguments)}function a(t){this.init(t)}return t.extend(l.prototype,{init:function(e,i){this.$input=t(e),this.options=n(t.extend(!0,{},l.defaults,i,{placeholder:this.$input.attr("placeholder")}),this.$input.data(),["url","loadOnce","apiParam","initialValue","userOptionAllowed"]),this.ens=".fastselect"+ ++s,this.hasCustomLoader=this.$input.is("input"),this.isMultiple=!!this.$input.attr("multiple"),this.userOptionAllowed=this.hasCustomLoader&&this.isMultiple&&this.options.userOptionAllowed,this.optionsCollection=new a(n({multipleValues:this.isMultiple},this.options,["url","loadOnce","parseData","matcher"])),this.setupDomElements(),this.setupFastsearch(),this.setupEvents()},setupDomElements:function(){this.$el=t("<div>").addClass(this.options.elementClass),this[this.isMultiple?"setupMultipleElement":"setupSingleElement"](function(){this.updateDomElements(),this.$controls.appendTo(this.$el),this.$el.insertAfter(this.$input),this.$input.detach().appendTo(this.$el)})},setupSingleElement:function(e){var s=this.processInitialOptions(),i=s&&s.length?s[0].text:this.options.placeholder;this.$el.addClass(this.options.singleModeClass),this.$controls=t("<div>").addClass(this.options.controlsClass),this.$toggleBtn=t("<div>").addClass(this.options.toggleButtonClass).text(i).appendTo(this.$el),this.$queryInput=t("<input>").attr("placeholder",this.options.searchPlaceholder).addClass(this.options.queryInputClass).appendTo(this.$controls),e.call(this)},setupMultipleElement:function(e){var s=this,i=s.options,n=this.processInitialOptions();this.$el.addClass(i.multipleModeClass),this.$controls=t("<div>").addClass(i.controlsClass),this.$queryInput=t("<input>").addClass(i.queryInputClass).appendTo(this.$controls),n&&t.each(n,function(t,e){s.addChoiceItem(e)}),e.call(this)},updateDomElements:function(){this.$el.toggleClass(this.options.noneSelectedClass,!this.optionsCollection.hasSelectedValues()),this.adjustQueryInputLayout()},processInitialOptions:function(){var e,s=this;return this.hasCustomLoader?(e=this.options.initialValue,t.isPlainObject(e)&&(e=[e])):e=t.map(this.$input.find("option:selected").get(),function(e){var s=t(e);return{text:s.text(),value:s.attr("value")}}),e&&t.each(e,function(t,e){s.optionsCollection.setSelected(e)}),e},addChoiceItem:function(e){t('<div data-text="'+e.text+'" data-value="'+e.value+'" class="'+this.options.choiceItemClass+'">'+t("<div>").html(e.text).text()+'<button class="'+this.options.choiceRemoveClass+'" type="button">×</button></div>').insertBefore(this.$queryInput)},setupFastsearch:function(){var e=this,s=this.options,o={};n(o,s,["resultsContClass","resultsOpenedClass","resultsFlippedClass","groupClass","itemClass","focusFirstItem","groupTitleClass","loadingClass","noResultsClass","noResultsText","focusedItemClass","flipOnBottom"]),this.fastsearch=new i(this.$queryInput.get(0),t.extend(o,{wrapSelector:this.isMultiple?this.$el:this.$controls,minQueryLength:0,typeTimeout:this.hasCustomLoader?s.typeTimeout:0,preventSubmit:!0,fillInputId:!1,responseFormat:{label:"text",groupCaption:"label"},onItemSelect:function(t,i,n){var o=s.maxItems;e.isMultiple&&o&&e.optionsCollection.getValues().length>o-1?s.onMaxItemsReached&&s.onMaxItemsReached(this):(e.setSelectedOption(i),e.writeToInput(),!e.isMultiple&&e.hide(),s.clearQueryOnSelect&&n.clear(),e.userOptionAllowed&&i.isUserOption&&(n.$resultsCont.remove(),delete n.$resultsCont,e.hide()),s.onItemSelect&&s.onItemSelect.call(e,t,i,e,n))},onItemCreate:function(t,i){i.$item=t,i.selected&&t.addClass(s.itemSelectedClass),e.userOptionAllowed&&i.isUserOption&&t.text(e.options.userOptionPrefix+t.text()).addClass(e.options.userOptionClass),s.onItemCreate&&s.onItemCreate.call(e,t,i,e)}})),this.fastsearch.getResults=function(){e.userOptionAllowed&&e.$queryInput.val().length>1&&e.renderOptions(),e.getOptions(function(){e.renderOptions(!0)})}},getOptions:function(e){var s=this.options,i={};if(this.hasCustomLoader){var n=t.trim(this.$queryInput.val());n&&s.apiParam&&(i[s.apiParam]=n),this.optionsCollection.fetch(i,e)}else!this.optionsCollection.models&&this.optionsCollection.reset(this.gleanSelectData(this.$input)),e()},namespaceEvents:function(t){return i.prototype.namespaceEvents.call(this,t)},setupEvents:function(){var e=this,s=this.options;this.isMultiple?(this.$el.on(this.namespaceEvents("click"),function(i){t(i.target).is(o(s.controlsClass))&&e.$queryInput.focus()}),this.$queryInput.on(this.namespaceEvents("keyup"),function(t){e.adjustQueryInputLayout(),e.show()}).on(this.namespaceEvents("focus"),function(){e.show()}),this.$el.on(this.namespaceEvents("click"),o(s.choiceRemoveClass),function(i){var n=t(i.currentTarget).closest(o(s.choiceItemClass));e.removeSelectedOption({value:n.attr("data-value"),text:n.attr("data-text")},n)})):this.$el.on(this.namespaceEvents("click"),o(s.toggleButtonClass),function(){e.$el.hasClass(s.activeClass)?e.hide():e.show(!0)})},adjustQueryInputLayout:function(){if(this.isMultiple&&this.$queryInput){var e=this.$el.hasClass(this.options.noneSelectedClass);this.$queryInput.toggleClass(this.options.queryInputExpandedClass,e),e?this.$queryInput.attr({style:"",placeholder:this.options.placeholder}):(this.$fakeInput=this.$fakeInput||t("<span>").addClass(this.options.fakeInputClass),this.$fakeInput.text(this.$queryInput.val().replace(/\s/g,"&nbsp;")),this.$queryInput.removeAttr("placeholder").css("width",this.$fakeInput.insertAfter(this.$queryInput).width()+20),this.$fakeInput.detach())}},show:function(t){this.$el.addClass(this.options.activeClass),t?this.$queryInput.focus():this.fastsearch.handleTyping(),this.documentCancelEvents("on")},hide:function(){this.$el.removeClass(this.options.activeClass),this.documentCancelEvents("off")},documentCancelEvents:function(t){i.prototype.documentCancelEvents.call(this,t,this.hide)},setSelectedOption:function(t){if(!this.optionsCollection.isSelected(t.value)){this.optionsCollection.setSelected(t);var e=this.optionsCollection.findWhere(function(e){return e.value===t.value});this.isMultiple?this.$controls&&this.addChoiceItem(t):(this.fastsearch&&this.fastsearch.$resultItems.removeClass(this.options.itemSelectedClass),this.$toggleBtn&&this.$toggleBtn.text(t.text)),e&&e.$item.addClass(this.options.itemSelectedClass),this.updateDomElements()}},removeSelectedOption:function(t,e){var s=this.optionsCollection.removeSelected(t);s&&s.$item&&s.$item.removeClass(this.options.itemSelectedClass),e?e.remove():this.$el.find(o(this.options.choiceItemClass)+'[data-value="'+t.value+'"]').remove(),this.updateDomElements(),this.writeToInput()},writeToInput:function(){var t=this.optionsCollection.getValues(),e=this.options.valueDelimiter,s=this.isMultiple?this.hasCustomLoader?t.join(e):t:t[0];this.$input.val(s).trigger("change")},renderOptions:function(t){var e,s=this.$queryInput.val();if(e=this.optionsCollection.models?(t?this.optionsCollection.filter(s):this.optionsCollection.models).slice(0):[],this.userOptionAllowed){var i=this.optionsCollection.models&&this.optionsCollection.findWhere(function(t){return t.value===s});s&&!i&&e.unshift({text:s,value:s,isUserOption:!0})}this.fastsearch.showResults(this.fastsearch.storeResponse(e).generateResults(e))},gleanSelectData:function(e){var s=this,i=e.children();return i.eq(0).is("optgroup")?t.map(i.get(),function(e){var i=t(e);return{label:i.attr("label"),items:s.gleanOptionsData(i.children())}}):this.gleanOptionsData(i)},gleanOptionsData:function(e){return t.map(e.get(),function(e){var s=t(e);return{text:s.text(),value:s.attr("value"),selected:s.is(":selected")}})},destroy:function(){e.off(this.ens),this.fastsearch.destroy(),this.$input.off(this.ens).detach().insertAfter(this.$el),this.$el.off(this.ens).remove(),this.$input.data()&&delete this.$input.data().fastselect}}),t.extend(a.prototype,{defaults:{loadOnce:!1,url:null,parseData:null,multipleValues:!1,matcher:function(t,e){return t.toLowerCase().indexOf(e.toLowerCase())>-1}},init:function(e){this.options=t.extend({},this.defaults,e),this.selectedValues={}},fetch:function(t,e){var s=this,i=function(){s.applySelectedValues(e)};this.options.loadOnce?(this.fetchDeferred=this.fetchDeferred||this.load(t),this.fetchDeferred.done(i)):this.load(t,i)},reset:function(t){this.models=this.options.parseData?this.options.parseData(t):t,this.applySelectedValues()},applySelectedValues:function(t){this.each(function(t){this.options.multipleValues&&t.selected?this.selectedValues[t.value]=!0:t.selected=!!this.selectedValues[t.value]}),t&&t.call(this)},load:function(e,s){var i=this,n=this.options;return t.get(n.url,e,function(t){i.models=n.parseData?n.parseData(t):t,s&&s.call(i)})},setSelected:function(t){this.options.multipleValues||(this.selectedValues={}),this.selectedValues[t.value]=!0,this.applySelectedValues()},removeSelected:function(t){var e=this.findWhere(function(e){return t.value===e.value});return e&&(e.selected=!1),delete this.selectedValues[t.value],e},isSelected:function(t){return!!this.selectedValues[t]},hasSelectedValues:function(){return this.getValues().length>0},each:function(e){var s=this;this.models&&t.each(this.models,function(i,n){n.items?t.each(n.items,function(t,i){e.call(s,i)}):e.call(s,n)})},where:function(t){var e=[];return this.each(function(s){t(s)&&e.push(s)}),e},findWhere:function(t){var e=this.where(t);return e.length?e[0]:void 0},filter:function(e){var s=this;function i(t){return s.options.matcher(t.text,e)?t:null}return e&&0!==e.length?t.map(this.models,function(e){if(e.items){var s=t.map(e.items,i);return s.length?{label:e.label,items:s}:null}return i(e)}):this.models},getValues:function(){return t.map(this.selectedValues,function(t,e){return t?e:null})}}),l.defaults={elementClass:"fstElement",singleModeClass:"fstSingleMode",noneSelectedClass:"fstNoneSelected",multipleModeClass:"fstMultipleMode",queryInputClass:"fstQueryInput",queryInputExpandedClass:"fstQueryInputExpanded",fakeInputClass:"fstFakeInput",controlsClass:"fstControls",toggleButtonClass:"fstToggleBtn",activeClass:"fstActive",itemSelectedClass:"fstSelected",choiceItemClass:"fstChoiceItem",choiceRemoveClass:"fstChoiceRemove",userOptionClass:"fstUserOption",resultsContClass:"fstResults",resultsOpenedClass:"fstResultsOpened",resultsFlippedClass:"fstResultsFilpped",groupClass:"fstGroup",itemClass:"fstResultItem",groupTitleClass:"fstGroupTitle",loadingClass:"fstLoading",noResultsClass:"fstNoResults",focusedItemClass:"fstFocused",matcher:null,url:null,loadOnce:!1,apiParam:"query",initialValue:null,clearQueryOnSelect:!0,minQueryLength:1,focusFirstItem:!1,flipOnBottom:!0,typeTimeout:150,userOptionAllowed:!1,valueDelimiter:",",maxItems:null,parseData:null,onItemSelect:null,onItemCreate:null,onMaxItemsReached:null,placeholder:"Choose option",searchPlaceholder:"Search options",noResultsText:"No results",userOptionPrefix:"Add "},t.Fastselect=l,t.Fastselect.OptionsCollection=a,t.fn.fastselect=function(e){return this.each(function(){t.data(this,"fastselect")||t.data(this,"fastselect",new l(this,e))})},t});